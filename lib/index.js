'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _util = require('util');

var _rx = require('rx');

var _rx2 = _interopRequireDefault(_rx);

var _botkit = require('botkit');

var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _conf = require('./conf');

var _conf2 = _interopRequireDefault(_conf);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _githubClient = require('./github-client');

var _githubClient2 = _interopRequireDefault(_githubClient);

var _frivolity = require('./frivolity');

var _frivolity2 = _interopRequireDefault(_frivolity);

var _githubHookListener = require('./github-hook-listener');

var _githubHookListener2 = _interopRequireDefault(_githubHookListener);

var _formatting = require('./formatting');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

if (_conf2.default.logLevel > 5) _rx2.default.config.longStackSupport = true;
const Observable = _rx2.default.Observable;

const logger = (0, _logger2.default)(_conf2.default);
const github = (0, _githubClient2.default)(_extends({ logger }, _conf2.default));
const botController = (0, _botkit.slackbot)({ logger });
const githubHook = (0, _githubHookListener2.default)(_extends({ logger }, _conf2.default));

const bot = botController.spawn({
  token: _conf2.default.slackToken,
  incoming_webhook: {
    url: _conf2.default.slackWebhookUrl
  }
}).startRTM();

const dobbs = (0, _frivolity2.default)(_conf2.default, botController);

function allCiSucceeded(_ref) {
  let repository = _ref.repository;
  let sha = _ref.sha;
  let statuses = _ref.statuses;
  let contents = _ref.contents;

  let successes = statuses.filter(_ref2 => {
    let state = _ref2.state;
    return state === 'success';
  });
  return _conf2.default.ciProviders.every(_ref3 => {
    let name = _ref3.name;
    let configFile = _ref3.configFile;
    let statusContext = _ref3.statusContext;

    let isConfigured = contents.some(_ref4 => {
      let path = _ref4.path;
      return path === configFile;
    });
    let successFound = !isConfigured || successes.find(_ref5 => {
      let context = _ref5.context;
      return context === statusContext;
    });
    if (isConfigured && successFound) {
      logger.notice(`${ name } build success for ${ repository.name }#${ sha }, triggered by`, successFound);
    }
    return !!successFound;
  });
}

function getNpmStatus(packageName) {
  return Observable.fromPromise((0, _nodeFetch2.default)(_conf2.default.npmRegistry + packageName).then(res => res.json()).catch(() => false));
}

let successfulBuilds$ = githubHook.incoming.filter(_ref6 => {
  let event = _ref6.event;
  let data = _ref6.data;
  return event === 'status' && data.state === 'success';
}).do(_ref7 => {
  let data = _ref7.data;
  return logger.info('Received success notification', data);
}).map(_ref8 => {
  let data = _ref8.data;

  let getRepoData = github.forRepo(data.repository.name);
  return Observable.forkJoin(Observable.just(data), getRepoData('statuses', data.sha), getRepoData('contents', '/', data.sha), (_ref9, statuses, contents) => {
    let repository = _ref9.repository;
    let sha = _ref9.sha;
    return { repository, sha, statuses, contents };
  });
}).concatAll().filter(_ref10 => {
  let repository = _ref10.repository;
  let sha = _ref10.sha;
  let statuses = _ref10.statuses;
  let contents = _ref10.contents;

  logger.info('Received full status for', repository.name, sha);
  let hasPkg = contents.some(_ref11 => {
    let path = _ref11.path;
    return path === 'package.json';
  });
  return hasPkg && allCiSucceeded({ repository, sha, statuses, contents });
}).map(_ref12 => {
  let repository = _ref12.repository;
  let sha = _ref12.sha;
  return Observable.forkJoin(Observable.of({ repository, sha }), github.forRepo(repository.name)('tags'), (_ref13, tags) => {
    let repository = _ref13.repository;
    let sha = _ref13.sha;
    return {
      repository,
      sha,
      tag: tags.find(_ref14 => {
        let commit = _ref14.commit;
        return commit && commit.sha === sha;
      })
    };
  });
}).concatAll().filter(_ref15 => {
  let tag = _ref15.tag;
  return tag && _semver2.default.clean(tag.name);
});

successfulBuilds$.subscribe(_ref16 => {
  let repository = _ref16.repository;
  let sha = _ref16.sha;
  let tag = _ref16.tag;

  let name = repository.name;
  logger.notice('gonna notify CI success on tag', name, sha);
  bot.sendWebhook(_extends({
    channel: _conf2.default.statusChannel,
    attachments: [{
      color: _formatting.colors.success,
      fallback: `${ name } ${ tag.name } ready for publish.`,
      pretext: `npm package build success for \`${ name }\`!`,
      title: `${ tag.name } of the ${ name } package is ready to be ` + `published to NPM.`,
      text: `When publishing, be sure your local repository is at ` + `that exact version: \`git checkout ${ tag.name } && npm ` + `publish\`.`,
      fields: Object.keys(tag).map(k => {
        let stringValue = typeof tag[k] === 'string' ? tag[k] : JSON.stringify(tag[k]);
        return {
          title: k,
          value: stringValue,
          short: stringValue.length < 20
        };
      }),
      mrkdwn_in: ['pretext', 'text']
    }]
  }, _formatting.formats.success));
}, logger.error);

function getPackageStatus(packageName, branch) {
  let getRepoData = github.forRepo(packageName);
  return getRepoData('tags').map(tags => Observable.forkJoin(Observable.just(tags), getRepoData('contents', '/', branch), getRepoData('statuses', branch), getRepoData('commits'), getNpmStatus(packageName), (tags, contents, statuses, commits, npmInfo) => ({ tags, contents, statuses, commits, npmInfo }))).concatAll().map(data => _extends({
    latestGoodTag: data.tags.find(tag => allCiSucceeded({
      repository: { name: packageName },
      sha: tag.commit.sha,
      statuses: data.statuses.filter(_ref17 => {
        let url = _ref17.url;
        return ~url.indexOf(tag.commit.sha);
      }),
      contents: data.contents
    })),
    ciProvidersConfigured: _conf2.default.ciProviders.filter(_ref18 => {
      let configFile = _ref18.configFile;
      return data.contents.some(_ref19 => {
        let path = _ref19.path;
        return path === configFile;
      });
    })
  }, data));
}

dobbs.hears(['status ([A-Za-z0-9\-\.\_]+)(?: ([A-Za-z0-9\-\/\_]+))?'], ['direct_mention'], (dobbs, msg) => {
  let packageName = msg.match[1];
  let branch = msg.match[2] || 'master';
  logger.info('package status requested', packageName, msg);

  let packageStatus$ = getPackageStatus(packageName, branch);

  packageStatus$.subscribe(data => {
    let status = (0, _formatting.formatPackageStatus)(_extends({ packageName, branch }, data));
    dobbs.reply(msg, _extends({
      text: `Status for \`${ packageName }\``,
      attachments: [{
        color: status.good ? _formatting.colors.success : _formatting.colors.error,
        title: status.title || (status.good ? 'Good News!' : 'Keep Calm!'),
        text: status.text,
        fields: Object.keys(status.fields).map(k => ({
          title: k,
          value: status.fields[k],
          short: status.fields[k].length < 20
        })),
        mrkdwn_in: ['text', 'fields']
      }],
      mrkdwn_in: ['text', 'fields']
    }, _formatting.formats.standard));
  }, e => {
    logger.error('status check failed', e);
    let reply = _extends({}, _formatting.formats.error);
    if (e.statusCode === 404 && e.headers && e.headers.server === 'GitHub.com') {
      reply.text = `Could not find \`${ packageName }\` in the ` + `\`${ _conf2.default.githubOrg }\` GitHub organization. Is it private? _Does ` + `it even exist?_`;
    } else {
      reply.text = `Boy, I had a doozy of a time trying to do that. Here ` + `is the error.`;
      reply.attachments = [{
        color: _formatting.colors.error,
        title: e.message,
        text: '```\n' + (0, _util.inspect)(e) + '\n```'
      }];
    }
    dobbs.reply(msg, reply);
  });
});
//# sourceMappingURL=data:application/json;base64,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RSxRQUFRLENBQUM7T0FDMUIsWUFsTE0sT0FBTyxDQWtMTCxRQUFRLEVBQ25CLENBQUM7R0FDSixFQUNELEFBQUMsQ0FBQyxJQUFLO0FBQ0wsVUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN2QyxRQUFJLEtBQUssZ0JBQU8sWUF2TEwsT0FBTyxDQXVMTSxLQUFLLENBQUMsQ0FBQztBQUMvQixRQUFJLENBQUMsQ0FBQyxVQUFVLEtBQUssR0FBRyxJQUNwQixDQUFDLENBQUMsT0FBTyxJQUNULENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLFlBQVksRUFBRTtBQUNyQyxXQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsaUJBQWlCLEdBQUUsV0FBVyxFQUFDLFVBQVUsQ0FBQyxHQUN0RCxDQUFDLEVBQUUsR0FBRSxlQUFLLFNBQVMsRUFBQyw2Q0FBNkMsQ0FBQyxHQUNsRSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0tBQ3JCLE1BQU07QUFDTCxXQUFLLENBQUMsSUFBSSxHQUFHLENBQUMscURBQXFELENBQUMsR0FDbEUsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUNsQixXQUFLLENBQUMsV0FBVyxHQUFHLENBQ2xCO0FBQ0UsYUFBSyxFQUFFLFlBbk1WLE1BQU0sQ0FtTVcsS0FBSztBQUNuQixhQUFLLEVBQUUsQ0FBQyxDQUFDLE9BQU87QUFDaEIsWUFBSSxFQUFFLE9BQU8sR0FBRyxVQS9NbkIsT0FBTyxFQStNb0IsQ0FBQyxDQUFDLEdBQUcsT0FBTztPQUNyQyxDQUNGLENBQUM7S0FDSDtBQUNELFNBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0dBQ3pCLENBQUMsQ0FBQztDQUNKLENBQ0YsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluc3BlY3QgfSBmcm9tICd1dGlsJztcbmltcG9ydCBSeCBmcm9tICdyeCc7XG5pbXBvcnQgeyBzbGFja2JvdCB9IGZyb20gJ2JvdGtpdCc7XG5pbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgY29uZiBmcm9tICcuL2NvbmYnO1xuaW1wb3J0IExvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgR2l0aHViQ2xpZW50IGZyb20gJy4vZ2l0aHViLWNsaWVudCc7XG5pbXBvcnQgZnJpdm9saXR5IGZyb20gJy4vZnJpdm9saXR5JztcbmltcG9ydCBHaXRodWJIb29rIGZyb20gJy4vZ2l0aHViLWhvb2stbGlzdGVuZXInO1xuaW1wb3J0IHsgY29sb3JzLCBmb3JtYXRzLCBmb3JtYXRQYWNrYWdlU3RhdHVzIH0gZnJvbSAnLi9mb3JtYXR0aW5nJztcblxuaWYgKGNvbmYubG9nTGV2ZWwgPiA1KSBSeC5jb25maWcubG9uZ1N0YWNrU3VwcG9ydCA9IHRydWU7XG5jb25zdCB7IE9ic2VydmFibGUgfSA9IFJ4O1xuXG5jb25zdCBsb2dnZXIgPSBMb2dnZXIoY29uZik7XG5jb25zdCBnaXRodWIgPSBHaXRodWJDbGllbnQoeyBsb2dnZXIsIC4uLmNvbmYgfSk7XG5jb25zdCBib3RDb250cm9sbGVyID0gc2xhY2tib3QoeyBsb2dnZXIgfSk7XG5jb25zdCBnaXRodWJIb29rID0gR2l0aHViSG9vayh7IGxvZ2dlciwgLi4uY29uZiB9KTtcblxuY29uc3QgYm90ID0gYm90Q29udHJvbGxlci5zcGF3bih7IFxuICB0b2tlbjogY29uZi5zbGFja1Rva2VuLFxuICBpbmNvbWluZ193ZWJob29rOiB7XG4gICAgdXJsOiBjb25mLnNsYWNrV2ViaG9va1VybFxuICB9XG59KS5zdGFydFJUTSgpO1xuXG5jb25zdCBkb2JicyA9IGZyaXZvbGl0eShjb25mLCBib3RDb250cm9sbGVyKTtcblxuZnVuY3Rpb24gYWxsQ2lTdWNjZWVkZWQoeyByZXBvc2l0b3J5LCBzaGEsIHN0YXR1c2VzLCBjb250ZW50cyB9KSB7XG4gIGxldCBzdWNjZXNzZXMgPSBzdGF0dXNlcy5maWx0ZXIoKHsgc3RhdGUgfSkgPT4gc3RhdGUgPT09ICdzdWNjZXNzJyk7XG4gIHJldHVybiBjb25mLmNpUHJvdmlkZXJzLmV2ZXJ5KFxuICAgICh7IG5hbWUsIGNvbmZpZ0ZpbGUsIHN0YXR1c0NvbnRleHQgfSkgPT4ge1xuICAgICAgbGV0IGlzQ29uZmlndXJlZCA9IGNvbnRlbnRzLnNvbWUoKHsgcGF0aCB9KSA9PiBwYXRoID09PSBjb25maWdGaWxlKTtcbiAgICAgIGxldCBzdWNjZXNzRm91bmQgPSAhaXNDb25maWd1cmVkIHx8XG4gICAgICAgIHN1Y2Nlc3Nlcy5maW5kKCh7IGNvbnRleHQgfSkgPT4gY29udGV4dCA9PT0gc3RhdHVzQ29udGV4dCk7XG4gICAgICBpZiAoaXNDb25maWd1cmVkICYmIHN1Y2Nlc3NGb3VuZCkge1xuICAgICAgICBsb2dnZXIubm90aWNlKFxuICAgICAgICAgIGAke25hbWV9IGJ1aWxkIHN1Y2Nlc3MgZm9yICR7cmVwb3NpdG9yeS5uYW1lfSMke3NoYX0sIHRyaWdnZXJlZCBieWAsXG4gICAgICAgICAgc3VjY2Vzc0ZvdW5kXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gISFzdWNjZXNzRm91bmQ7XG4gICAgfVxuICApXG59XG5cbmZ1bmN0aW9uIGdldE5wbVN0YXR1cyhwYWNrYWdlTmFtZSkge1xuICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShcbiAgICBmZXRjaChjb25mLm5wbVJlZ2lzdHJ5ICsgcGFja2FnZU5hbWUpXG4gICAgICAudGhlbigocmVzKSA9PiByZXMuanNvbigpKVxuICAgICAgLmNhdGNoKCgpID0+IGZhbHNlKVxuICApO1xufVxuXG5sZXQgc3VjY2Vzc2Z1bEJ1aWxkcyQgPSBnaXRodWJIb29rLmluY29taW5nLmZpbHRlcihcbiAgKHsgZXZlbnQsIGRhdGEgfSkgPT4gZXZlbnQgPT09ICdzdGF0dXMnICYmIGRhdGEuc3RhdGUgPT09ICdzdWNjZXNzJ1xuKS5kbyhcbiAgKHsgZGF0YSB9KSA9PiBsb2dnZXIuaW5mbygnUmVjZWl2ZWQgc3VjY2VzcyBub3RpZmljYXRpb24nLCBkYXRhKVxuKS5tYXAoXG4gICh7IGRhdGEgfSkgPT4ge1xuICAgIGxldCBnZXRSZXBvRGF0YSA9IGdpdGh1Yi5mb3JSZXBvKGRhdGEucmVwb3NpdG9yeS5uYW1lKTtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5mb3JrSm9pbihcbiAgICAgIE9ic2VydmFibGUuanVzdChkYXRhKSxcbiAgICAgIGdldFJlcG9EYXRhKCdzdGF0dXNlcycsIGRhdGEuc2hhKSxcbiAgICAgIGdldFJlcG9EYXRhKCdjb250ZW50cycsICcvJywgZGF0YS5zaGEpLFxuICAgICAgKHsgcmVwb3NpdG9yeSwgc2hhIH0sIHN0YXR1c2VzLCBjb250ZW50cyApID0+XG4gICAgICAgICh7IHJlcG9zaXRvcnksIHNoYSwgc3RhdHVzZXMsIGNvbnRlbnRzIH0pXG4gICAgKTtcbiAgfVxuKS5jb25jYXRBbGwoKS5maWx0ZXIoXG4gICh7IHJlcG9zaXRvcnksIHNoYSwgc3RhdHVzZXMsIGNvbnRlbnRzIH0pID0+IHtcbiAgICBsb2dnZXIuaW5mbygnUmVjZWl2ZWQgZnVsbCBzdGF0dXMgZm9yJywgcmVwb3NpdG9yeS5uYW1lLCAgc2hhKTtcbiAgICBsZXQgaGFzUGtnID0gY29udGVudHMuc29tZSgoeyBwYXRoIH0pID0+IHBhdGggPT09ICdwYWNrYWdlLmpzb24nKTtcbiAgICByZXR1cm4gaGFzUGtnICYmIGFsbENpU3VjY2VlZGVkKHsgcmVwb3NpdG9yeSwgc2hhLCBzdGF0dXNlcywgY29udGVudHMgfSk7XG4gIH1cbikubWFwKFxuICAoeyByZXBvc2l0b3J5LCBzaGEgfSkgPT4gT2JzZXJ2YWJsZS5mb3JrSm9pbihcbiAgICBPYnNlcnZhYmxlLm9mKHsgcmVwb3NpdG9yeSwgc2hhIH0pLFxuICAgIGdpdGh1Yi5mb3JSZXBvKHJlcG9zaXRvcnkubmFtZSkoJ3RhZ3MnKSxcbiAgICAoeyByZXBvc2l0b3J5LCBzaGEgfSwgdGFncykgPT5cbiAgICAgICh7XG4gICAgICAgIHJlcG9zaXRvcnksXG4gICAgICAgIHNoYSxcbiAgICAgICAgdGFnOiB0YWdzLmZpbmQoKHsgY29tbWl0IH0pID0+IGNvbW1pdCAmJiBjb21taXQuc2hhID09PSBzaGEpXG4gICAgICB9KVxuICApXG4pLmNvbmNhdEFsbCgpLmZpbHRlcigoeyB0YWcgfSkgPT4gdGFnICYmIHNlbXZlci5jbGVhbih0YWcubmFtZSkpO1xuXG5zdWNjZXNzZnVsQnVpbGRzJC5zdWJzY3JpYmUoXG4gICh7IHJlcG9zaXRvcnksIHNoYSwgdGFnIH0pID0+IHtcbiAgICBsZXQgbmFtZSA9IHJlcG9zaXRvcnkubmFtZTtcbiAgICBsb2dnZXIubm90aWNlKFxuICAgICAgJ2dvbm5hIG5vdGlmeSBDSSBzdWNjZXNzIG9uIHRhZycsIG5hbWUsIHNoYVxuICAgICk7XG4gICAgYm90LnNlbmRXZWJob29rKHtcbiAgICAgIGNoYW5uZWw6IGNvbmYuc3RhdHVzQ2hhbm5lbCxcbiAgICAgIGF0dGFjaG1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBjb2xvcjogY29sb3JzLnN1Y2Nlc3MsXG4gICAgICAgICAgZmFsbGJhY2s6IGAke25hbWV9ICR7dGFnLm5hbWV9IHJlYWR5IGZvciBwdWJsaXNoLmAsXG4gICAgICAgICAgcHJldGV4dDogYG5wbSBwYWNrYWdlIGJ1aWxkIHN1Y2Nlc3MgZm9yIFxcYCR7bmFtZX1cXGAhYCxcbiAgICAgICAgICB0aXRsZTogYCR7dGFnLm5hbWV9IG9mIHRoZSAke25hbWV9IHBhY2thZ2UgaXMgcmVhZHkgdG8gYmUgYCArXG4gICAgICAgICAgICBgcHVibGlzaGVkIHRvIE5QTS5gLFxuICAgICAgICAgICAgdGV4dDogYFdoZW4gcHVibGlzaGluZywgYmUgc3VyZSB5b3VyIGxvY2FsIHJlcG9zaXRvcnkgaXMgYXQgYCArXG4gICAgICAgICAgICBgdGhhdCBleGFjdCB2ZXJzaW9uOiBcXGBnaXQgY2hlY2tvdXQgJHt0YWcubmFtZX0gJiYgbnBtIGAgK1xuICAgICAgICAgICAgYHB1Ymxpc2hcXGAuYCxcbiAgICAgICAgICBmaWVsZHM6IE9iamVjdC5rZXlzKHRhZykubWFwKChrKSA9PiB7XG4gICAgICAgICAgICBsZXQgc3RyaW5nVmFsdWUgPSB0eXBlb2YgdGFnW2tdID09PSAnc3RyaW5nJyA/IHRhZ1trXSA6XG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGFnW2tdKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHRpdGxlOiBrLFxuICAgICAgICAgICAgICB2YWx1ZTogc3RyaW5nVmFsdWUsXG4gICAgICAgICAgICAgIHNob3J0OiBzdHJpbmdWYWx1ZS5sZW5ndGggPCAyMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBtcmtkd25faW46IFsncHJldGV4dCcsICd0ZXh0J11cbiAgICAgICAgfVxuICAgICAgXSxcbiAgICAgIC4uLmZvcm1hdHMuc3VjY2Vzc1xuICAgIH0pO1xuICB9LFxuICBsb2dnZXIuZXJyb3Jcbik7XG5cbmZ1bmN0aW9uIGdldFBhY2thZ2VTdGF0dXMocGFja2FnZU5hbWUsIGJyYW5jaCkge1xuICBsZXQgZ2V0UmVwb0RhdGEgPSBnaXRodWIuZm9yUmVwbyhwYWNrYWdlTmFtZSk7XG4gIHJldHVybiBnZXRSZXBvRGF0YSgndGFncycpXG4gIC5tYXAoXG4gICAgKHRhZ3MpID0+IE9ic2VydmFibGUuZm9ya0pvaW4oXG4gICAgICBPYnNlcnZhYmxlLmp1c3QodGFncyksXG4gICAgICBnZXRSZXBvRGF0YSgnY29udGVudHMnLCAnLycsIGJyYW5jaCksXG4gICAgICBnZXRSZXBvRGF0YSgnc3RhdHVzZXMnLCBicmFuY2gpLFxuICAgICAgZ2V0UmVwb0RhdGEoJ2NvbW1pdHMnKSxcbiAgICAgIGdldE5wbVN0YXR1cyhwYWNrYWdlTmFtZSksXG4gICAgICAodGFncywgY29udGVudHMsIHN0YXR1c2VzLCBjb21taXRzLCBucG1JbmZvKSA9PlxuICAgICAgICAoeyB0YWdzLCBjb250ZW50cywgc3RhdHVzZXMsIGNvbW1pdHMsIG5wbUluZm8gfSlcbiAgICApXG4gICkuY29uY2F0QWxsKCkubWFwKFxuICAgIChkYXRhKSA9PiAoe1xuICAgICAgbGF0ZXN0R29vZFRhZzogZGF0YS50YWdzLmZpbmQoXG4gICAgICAgICh0YWcpID0+IGFsbENpU3VjY2VlZGVkKHtcbiAgICAgICAgICByZXBvc2l0b3J5OiB7IG5hbWU6IHBhY2thZ2VOYW1lIH0sXG4gICAgICAgICAgc2hhOiB0YWcuY29tbWl0LnNoYSxcbiAgICAgICAgICBzdGF0dXNlczogZGF0YS5zdGF0dXNlcy5maWx0ZXIoXG4gICAgICAgICAgICAoeyB1cmwgfSkgPT4gfnVybC5pbmRleE9mKHRhZy5jb21taXQuc2hhKVxuICAgICAgICAgICksXG4gICAgICAgICAgY29udGVudHM6IGRhdGEuY29udGVudHNcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBjaVByb3ZpZGVyc0NvbmZpZ3VyZWQ6IGNvbmYuY2lQcm92aWRlcnMuZmlsdGVyKFxuICAgICAgICAoeyBjb25maWdGaWxlIH0pID0+XG4gICAgICAgICAgZGF0YS5jb250ZW50cy5zb21lKCh7IHBhdGggfSkgPT4gcGF0aCA9PT0gY29uZmlnRmlsZSlcbiAgICAgICksXG4gICAgICAuLi5kYXRhXG4gICAgfSlcbiAgKVxufVxuXG5cbmRvYmJzLmhlYXJzKFxuICBbJ3N0YXR1cyAoW0EtWmEtejAtOVxcLVxcLlxcX10rKSg/OiAoW0EtWmEtejAtOVxcLVxcL1xcX10rKSk/J10sXG4gIFsnZGlyZWN0X21lbnRpb24nXSxcbiAgKGRvYmJzLCBtc2cpID0+IHtcbiAgICBsZXQgcGFja2FnZU5hbWUgPSBtc2cubWF0Y2hbMV07XG4gICAgbGV0IGJyYW5jaCA9IG1zZy5tYXRjaFsyXSB8fCAnbWFzdGVyJztcbiAgICBsb2dnZXIuaW5mbygncGFja2FnZSBzdGF0dXMgcmVxdWVzdGVkJywgcGFja2FnZU5hbWUsIG1zZyk7XG5cbiAgICBsZXQgcGFja2FnZVN0YXR1cyQgPSBnZXRQYWNrYWdlU3RhdHVzKHBhY2thZ2VOYW1lLCBicmFuY2gpO1xuXG4gICAgcGFja2FnZVN0YXR1cyQuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICBsZXQgc3RhdHVzID0gZm9ybWF0UGFja2FnZVN0YXR1cyhcbiAgICAgICAgeyBwYWNrYWdlTmFtZSwgYnJhbmNoLCAuLi5kYXRhfVxuICAgICAgKTtcbiAgICAgIGRvYmJzLnJlcGx5KG1zZywge1xuICAgICAgICB0ZXh0OiBgU3RhdHVzIGZvciBcXGAke3BhY2thZ2VOYW1lfVxcYGAsXG4gICAgICAgIGF0dGFjaG1lbnRzOiBbe1xuICAgICAgICAgIGNvbG9yOiBzdGF0dXMuZ29vZCA/IGNvbG9ycy5zdWNjZXNzIDogY29sb3JzLmVycm9yLFxuICAgICAgICAgIHRpdGxlOiBzdGF0dXMudGl0bGUgfHwgKHN0YXR1cy5nb29kID8gJ0dvb2QgTmV3cyEnIDogJ0tlZXAgQ2FsbSEnKSxcbiAgICAgICAgICB0ZXh0OiBzdGF0dXMudGV4dCxcbiAgICAgICAgICBmaWVsZHM6IE9iamVjdC5rZXlzKHN0YXR1cy5maWVsZHMpLm1hcCgoaykgPT4gKHtcbiAgICAgICAgICAgIHRpdGxlOiBrLFxuICAgICAgICAgICAgdmFsdWU6IHN0YXR1cy5maWVsZHNba10sXG4gICAgICAgICAgICBzaG9ydDogc3RhdHVzLmZpZWxkc1trXS5sZW5ndGggPCAyMFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgICBtcmtkd25faW46IFsndGV4dCcsICdmaWVsZHMnXVxuICAgICAgICB9XSxcbiAgICAgICAgbXJrZHduX2luOiBbJ3RleHQnLCAnZmllbGRzJ10sXG4gICAgICAgIC4uLmZvcm1hdHMuc3RhbmRhcmRcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgKGUpID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcignc3RhdHVzIGNoZWNrIGZhaWxlZCcsIGUpO1xuICAgICAgbGV0IHJlcGx5ID0gey4uLmZvcm1hdHMuZXJyb3J9O1xuICAgICAgaWYgKGUuc3RhdHVzQ29kZSA9PT0gNDA0ICYmXG4gICAgICAgICAgZS5oZWFkZXJzICYmXG4gICAgICAgICAgZS5oZWFkZXJzLnNlcnZlciA9PT0gJ0dpdEh1Yi5jb20nKSB7XG4gICAgICAgIHJlcGx5LnRleHQgPSBgQ291bGQgbm90IGZpbmQgXFxgJHtwYWNrYWdlTmFtZX1cXGAgaW4gdGhlIGAgK1xuICAgICAgICAgIGBcXGAke2NvbmYuZ2l0aHViT3JnfVxcYCBHaXRIdWIgb3JnYW5pemF0aW9uLiBJcyBpdCBwcml2YXRlPyBfRG9lcyBgICtcbiAgICAgICAgICBgaXQgZXZlbiBleGlzdD9fYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcGx5LnRleHQgPSBgQm95LCBJIGhhZCBhIGRvb3p5IG9mIGEgdGltZSB0cnlpbmcgdG8gZG8gdGhhdC4gSGVyZSBgICtcbiAgICAgICAgICBgaXMgdGhlIGVycm9yLmA7XG4gICAgICAgIHJlcGx5LmF0dGFjaG1lbnRzID0gW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZXJyb3IsXG4gICAgICAgICAgICB0aXRsZTogZS5tZXNzYWdlLFxuICAgICAgICAgICAgdGV4dDogJ2BgYFxcbicgKyBpbnNwZWN0KGUpICsgJ1xcbmBgYCdcbiAgICAgICAgICB9XG4gICAgICAgIF07XG4gICAgICB9XG4gICAgICBkb2Jicy5yZXBseShtc2csIHJlcGx5KTtcbiAgICB9KTtcbiAgfVxuKTtcbiJdfQ==